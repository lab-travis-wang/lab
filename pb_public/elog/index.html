<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logs - Lab</title>
  <!-- Load local Tailwind from static assets -->
  <script src="/static/js/tailwindcss_3.4.17.js"></script>
  <!-- Load marked for markdown rendering -->
  <script src="/static/js/marked_12.0.2.min.js"></script>
  <link rel="stylesheet" href="/static/css/main.css">
  <script src="/static/js/navbar.js"></script>
  <script src="/static/js/footer.js"></script>
</head>

<body class="selection:bg-black selection:text-white">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header id="app-header"></header>

    <main class="flex-1 animate-fade-in">
      <div id="main-content">
        <!-- Content will be injected here -->
        <div class="flex justify-center py-24">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        </div>
      </div>
    </main>

    <footer id="app-footer"></footer>
  </div>

  <script>
    let currentLang = 'en';
    const CACHE_BUST = String(Date.now());

    function noCacheUrl(url) {
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}v=${encodeURIComponent(CACHE_BUST)}`;
    }

    // Router
    window.addEventListener('hashchange', handleRoute);
    window.addEventListener('load', handleRoute);

    // Language handling
    let langChangeListenerAttached = false;

    window.addEventListener('lang-change', (e) => {
      currentLang = e.detail.lang;
      // Only re-render content on first event to avoid infinite loop with NavBar.init()
      // Subsequent lang changes won't trigger re-render to prevent infinite fetch loops
      if (!langChangeListenerAttached) {
        langChangeListenerAttached = true;
        const currentHash = window.location.hash || '#/';
        if (currentHash === '#/tasks') {
          renderTasks();
        } else if (currentHash.startsWith('#/') && currentHash.length > 2) {
          renderLogDetail(currentHash.substring(2));
        } else {
          renderLogList();
        }
      }
    });

    // Markdown Renderer setup
    if (window.marked && typeof window.marked.setOptions === 'function' && typeof window.marked.Renderer === 'function') {
      const renderer = new window.marked.Renderer();

      renderer.heading = (text, level) => {
        const sizes = {
          1: 'text-4xl md:text-5xl font-black tracking-tighter mb-8',
          2: 'text-2xl md:text-3xl font-black mb-6 mt-12',
          3: 'text-xl font-black mb-4 mt-10',
          4: 'text-lg font-black mb-4 mt-8'
        };
        const sizeClass = sizes[level] || 'text-base font-black mb-4 mt-6';
        return `<h${level} class="${sizeClass} text-gray-900">${text}</h${level}>`;
      };

      renderer.paragraph = (text) => `<p class="text-xl text-gray-600 leading-relaxed font-medium mb-6 last:mb-0">${text}</p>`;
      renderer.strong = (text) => `<strong class="font-black text-gray-900">${text}</strong>`;
      renderer.codespan = (code) => `<code class="font-black text-sm bg-gray-100 px-2 py-0.5 rounded text-accent tracking-tight">${code}</code>`;
      renderer.code = (code, lang) => {
        const language = lang ? `language-${escapeHtml(lang)}` : '';
        return `\n<div class="my-8 rounded-[2rem] bg-gray-900 text-gray-100 p-8 overflow-x-auto shadow-2xl relative group">
          ${lang ? `<span class="absolute top-4 right-6 text-[10px] font-black uppercase text-gray-500 tracking-widest opacity-40">${lang}</span>` : ''}
          <pre><code class="font-mono text-sm ${language}">${escapeHtml(code)}</code></pre>
        </div>\n`;
      };
      renderer.blockquote = (quote) => `<blockquote class="my-10 border-l-8 border-gray-100 pl-8 text-2xl text-gray-400 italic font-medium leading-relaxed">${quote}</blockquote>`;
      renderer.list = (body, ordered, start) => {
        const tag = ordered ? 'ol' : 'ul';
        const style = ordered ? 'list-decimal' : 'list-disc';
        return `<${tag} class="my-8 pl-8 ${style} space-y-4 text-xl text-gray-600 font-medium">${body}</${tag}>`;
      };
      renderer.link = (href, title, text) => `<a class="text-gray-900 font-black underline decoration-4 decoration-accent/20 hover:decoration-accent transition-all underline-offset-4" href="${escapeHtml(href)}"${title ? ` title="${escapeHtml(title)}"` : ''}>${text}</a>`;
      renderer.image = (href, title, text) => `<img class="my-10 max-w-full rounded-[2.5rem] border-8 border-gray-50 bg-gray-50 shadow-sm" src="${escapeHtml(href)}" alt="${escapeHtml(text)}" ${title ? ` title="${escapeHtml(title)}"` : ''}/>`;

      window.marked.setOptions({
        gfm: true,
        breaks: true,
        headerIds: false,
        mangle: false,
        renderer
      });
    }

    async function handleRoute() {
      const hash = window.location.hash || '#/';
      NavBar.init(hash === '#/tasks' ? 'tasks' : 'logs');
      currentLang = NavBar.getLang();

      if (hash === '#/tasks') {
        renderTasks();
      } else if (hash.startsWith('#/experiments/')) {
        const experimentId = hash.substring(14);
        setExperimentIdFilter(experimentId);
        renderLogList(experimentId);
      } else if (hash.startsWith('#/') && hash.length > 2) {
        renderLogDetail(hash.substring(2));
      } else {
        renderLogList();
      }
    }

    function setExperimentIdFilter(value) {
      const url = new URL(window.location.href);
      if (value) url.searchParams.set('experiment_id', value);
      else url.searchParams.delete('experiment_id');
      url.searchParams.delete('experimentId'); url.searchParams.delete('eid');
      window.history.replaceState(null, '', url.pathname + url.search + url.hash);
    }

    function getExperimentIdFilter() {
      const url = new URL(window.location.href);
      return url.searchParams.get('experiment_id') || url.searchParams.get('experimentId') || url.searchParams.get('eid') || '';
    }

    async function renderLogList(experimentIdFromRoute = null) {
      const content = document.getElementById('main-content');
      content.innerHTML = '<div class="flex justify-center py-24"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div></div>';

      try {
        const [manifestRes, tasksRes] = await Promise.all([
          fetch(noCacheUrl('/elog/manifest.json'), { cache: 'no-store' }),
          fetch(noCacheUrl('/elog/tasks.md'), { cache: 'no-store' })
        ]);

        const logs = await manifestRes.json();
        logs.sort((a, b) => new Date(b.date) - new Date(a.date));

        const experimentIdFilter = (experimentIdFromRoute || getExperimentIdFilter()).trim();
        const allExperimentIds = Array.from(new Set(logs.map(log => String(log?.experiment_id || '').trim()).filter(Boolean))).sort();
        const filteredLogs = experimentIdFilter ? logs.filter(log => String(log?.experiment_id || '').trim() === experimentIdFilter) : logs;

        let html = `
          <div class="max-w-6xl mx-auto px-6 py-16">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-8 mb-16">
              <div>
                ${experimentIdFilter ? `
                  <a href="#/" class="inline-flex items-center text-sm font-bold text-gray-400 hover:text-black mb-4 transition-colors">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    ${currentLang === 'zh' ? '返回全部日志' : 'Back to All Logs'}
                  </a>
                ` : ''}
                <h1 class="text-5xl md:text-6xl font-black tracking-tighter text-gray-900 mb-4">${currentLang === 'zh' ? '实验日志' : 'Logs'}</h1>
                <p class="text-xl text-gray-500 font-medium">${currentLang === 'zh' ? '记录实验进展与深度思考' : 'Tracking progress and deep thoughts'}</p>
              </div>
              <div class="shrink-0 w-full md:w-64">
                <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-3" for="experiment-id-filter">${currentLang === 'zh' ? '实验筛选' : 'Filter by Exp'}</label>
                <div class="relative group">
                  <select id="experiment-id-filter" class="w-full appearance-none glass rounded-xl px-4 py-3 text-sm font-bold text-gray-900 focus:outline-none focus:ring-2 focus:ring-black cursor-pointer">
                    <option value="">${currentLang === 'zh' ? '全部实验' : 'All Experiments'}</option>
                    ${allExperimentIds.map(id => `<option value="${escapeHtml(id)}"${id === experimentIdFilter ? ' selected' : ''}>${escapeHtml(id)}</option>`).join('')}
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400 group-hover:text-black transition-colors">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </div>
                </div>
              </div>
            </div>
            ${experimentIdFilter ? `
              <div class="mb-8 p-4 bg-accent/5 rounded-xl border border-accent/20">
                <span class="text-sm font-bold text-accent">${currentLang === 'zh' ? '显示与实验相关日志:' : 'Showing logs for experiment:'}</span>
                <span class="ml-2 px-3 py-1 bg-accent text-white text-sm font-bold rounded-full">${escapeHtml(experimentIdFilter)}</span>
              </div>
            ` : ''}
            <div class="grid grid-cols-1 gap-4">
              ${filteredLogs.length > 0 ? filteredLogs.map(log => `
                <a href="#/${log.filename}" class="bold-card group p-6 md:p-8 rounded-[2rem]">
                  <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
                    <div class="min-w-0">
                      <div class="flex flex-wrap items-center gap-3 mb-4">
                        <span class="text-xs font-black text-accent uppercase tracking-widest">${log.date}</span>
                        ${String(log?.experiment_id || '').trim() ? `<span class="px-2 py-0.5 border border-gray-200 rounded text-[10px] font-black text-gray-400 uppercase tracking-tighter hover:border-black hover:text-black transition-colors">${escapeHtml(log.experiment_id)}</span>` : ''}
                      </div>
                      <h2 class="text-2xl md:text-3xl font-black text-gray-900 group-hover:text-accent transition-colors mb-4">${log.title}</h2>
                      <div class="flex flex-wrap gap-2">
                        ${log.tags.map(tag => `<span class="px-3 py-1 bg-gray-50 text-gray-500 rounded-full text-[10px] font-bold uppercase tracking-widest border border-gray-100">#${tag}</span>`).join('')}
                      </div>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-black group-hover:text-white transition-all transform group-hover:translate-x-1 shrink-0 ml-auto md:ml-0">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </div>
                  </div>
                </a>
              `).join('') : `
                <div class="text-center py-16 glass rounded-[2rem] border-dashed">
                  <p class="text-gray-400 font-bold text-xl">${currentLang === 'zh' ? '暂无日志' : 'No logs found.'}</p>
                </div>
              `}
            </div>
          </div>`;
        content.innerHTML = html;
        const select = document.getElementById('experiment-id-filter');
        select?.addEventListener('change', () => {
          setExperimentIdFilter(select.value);
          renderLogList();
        });
      } catch (err) {
        console.error(err);
        content.innerHTML = `<div class="max-w-6xl mx-auto px-6 py-24 text-red-500 font-bold">Error loading logs: ${err.message}</div>`;
      }
    }

    async function renderTasks() {
      const content = document.getElementById('main-content');
      content.innerHTML = '<div class="flex justify-center py-24"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div></div>';

      try {
        const response = await fetch(noCacheUrl('/elog/tasks.md'), { cache: 'no-store' });
        const markdown = await response.text();
        const lines = markdown.split('\n');
        const board = [];
        let currentColumn = null;
        let currentTask = null;

        lines.forEach(line => {
          const trimmed = line.trim();
          if (trimmed.startsWith('## ')) {
            if (currentColumn) board.push(currentColumn);
            currentColumn = { title: trimmed.substring(3).trim(), tasks: [] };
            currentTask = null;
          } else if (trimmed.startsWith('- [ ] ') || trimmed.startsWith('- [x] ')) {
            if (currentColumn) {
              currentTask = { text: trimmed.substring(6).trim(), isDone: trimmed.startsWith('- [x] '), experimentId: '', detail: '' };
              currentColumn.tasks.push(currentTask);
            }
          } else if (line.startsWith('  - experiment_id:') && currentTask) {
            currentTask.experimentId = line.substring(18).trim();
          } else if (line.startsWith('  - detail:') && currentTask) {
            currentTask.detail = line.substring(11).trim();
          } else if (trimmed.startsWith('> ') && currentTask && currentTask.detail) {
            currentTask.detail += ' ' + trimmed.substring(2).trim();
          }
        });
        if (currentColumn) board.push(currentColumn);

        let html = `
          <div class="max-w-6xl mx-auto px-6 py-16">
            <div class="mb-16">
              <h1 class="text-5xl font-black tracking-tighter text-gray-900 mb-4">${currentLang === 'zh' ? '项目看板' : 'Kanban'}</h1>
              <p class="text-xl text-gray-500 font-medium">${currentLang === 'zh' ? '实时追踪正在构建的功能与实验' : 'Tracking real-time progress of experiments'}</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
              ${board.map((col, idx) => `
                <details class="group flex flex-col gap-6 select-none" ${window.innerWidth > 768 ? 'open' : ''}>
                  <summary class="list-none cursor-pointer flex items-center justify-between pb-6 border-b-4 border-black group-open:mb-6 transition-all">
                    <div class="flex items-center gap-3">
                      <h3 class="text-2xl font-black uppercase tracking-tighter">${escapeHtml(col.title)}</h3>
                      <span class="px-3 py-1 bg-black text-white text-[10px] font-black rounded-full">${col.tasks.length}</span>
                    </div>
                    <div class="text-gray-300 group-open:rotate-180 transition-transform duration-300">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"/></svg>
                    </div>
                  </summary>
                  <div class="space-y-4 pb-8">
                    ${col.tasks.length === 0 ? `<div class="p-8 border-2 border-dashed border-gray-200 rounded-[2rem] text-center text-gray-300 font-bold">${currentLang === 'zh' ? '空空如也' : 'EMPTY'}</div>` :
            col.tasks.map(task => `
                        <div class="bold-card p-6 rounded-[1.5rem] group/card ${task.isDone ? 'opacity-40' : ''}">
                          <div class="flex items-start gap-4">
                            <div class="mt-1 ${task.isDone ? 'text-green-500' : 'text-gray-200'} shrink-0">
                              ${task.isDone ? '<span class="text-xl leading-none">✅</span>' : '<div class="w-5 h-5 border-4 border-current rounded-lg"></div>'}
                            </div>
                            <div class="flex-1 min-w-0">
                              <span class="font-bold text-gray-900 leading-tight ${task.isDone ? 'line-through' : ''}">${escapeHtml(task.text)}</span>
                              ${task.detail ? `
                                <p class="mt-3 text-sm text-gray-500 leading-relaxed">${escapeHtml(task.detail)}</p>
                              ` : ''}
                              ${task.experimentId ? `
                                <a href="/#/${task.experimentId}" class="mt-3 inline-flex items-center text-xs font-bold text-accent hover:text-black transition-colors">
                                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                  ${currentLang === 'zh' ? '查看实验' : 'View Experiment'}
                                </a>
                                <a href="/elog/#/experiments/${task.experimentId}" class="mt-3 ml-3 inline-flex items-center text-xs font-bold text-gray-400 hover:text-black transition-colors">
                                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                  ${currentLang === 'zh' ? '相关日志' : 'Logs'}
                                </a>
                              ` : ''}
                            </div>
                          </div>
                        </div>
                      `).join('')}
                  </div>
                </details>
              `).join('')}
            </div>
          </div>`;
        content.innerHTML = html;
      } catch (err) {
        console.error(err);
        content.innerHTML = `<div class="max-w-6xl mx-auto px-6 py-24 text-red-500 font-bold">Error loading tasks: ${err.message}</div>`;
      }
    }

    async function renderLogDetail(filename) {
      const content = document.getElementById('main-content');
      content.innerHTML = '<div class="flex justify-center py-24"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div></div>';

      try {
        const [manifestRes, contentRes, tasksRes] = await Promise.all([
          fetch(noCacheUrl('/elog/manifest.json'), { cache: 'no-store' }),
          fetch(noCacheUrl('/elog/' + filename), { cache: 'no-store' }),
          fetch(noCacheUrl('/elog/tasks.md'), { cache: 'no-store' })
        ]);
        const logs = await manifestRes.json();
        const meta = logs.find(l => l.filename === filename);
        const markdown = await contentRes.text();
        const renderedHtml = window.marked.parse(markdown);

        const tasksMarkdown = await tasksRes.text();
        const taskLines = tasksMarkdown.split('\n');
        const allTasks = [];
        let currentTask = null;

        taskLines.forEach(line => {
          const trimmed = line.trim();
          const taskIdMatch = trimmed.match(/\[([^\]]+)\]$/);
          if (trimmed.startsWith('- [ ] ') || trimmed.startsWith('- [x] ')) {
            const taskIds = taskIdMatch 
              ? taskIdMatch[1].split(',').map(id => id.trim()) 
              : [];
            currentTask = { 
              text: trimmed.substring(6).replace(/\s*\[[^\]]+\]$/, '').trim(), 
              isDone: trimmed.startsWith('- [x] '),
              taskIds: taskIds
            };
            allTasks.push(currentTask);
          }
        });

        const relatedTasks = (meta?.related_tasks || []).map(taskId => {
          let task = allTasks.find(t => t.taskIds.includes(taskId));
          if (task) return { ...task, taskId };
          task = allTasks.find(t => t.text.toLowerCase().includes(taskId.toLowerCase()));
          return task ? { ...task, taskId } : { text: taskId, isDone: false, taskIds: [taskId], taskId };
        });

        content.innerHTML = `
          <div class="max-w-4xl mx-auto px-6 py-16">
            <a href="#/" class="inline-flex items-center text-sm font-bold text-gray-400 hover:text-black mb-12 transition-colors uppercase tracking-widest">
              <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
              ${currentLang === 'zh' ? '返回日志' : 'Back'}
            </a>
            ${meta ? `
              <div class="mb-16 border-b border-gray-100 pb-16">
                 <div class="flex items-center gap-4 mb-6">
                    <span class="text-xs font-black text-accent uppercase tracking-widest">${meta.date}</span>
                    <a href="/elog/#/experiments/${meta.experiment_id}" class="px-2 py-0.5 border border-gray-200 rounded text-[10px] font-black text-gray-400 uppercase tracking-tighter hover:border-black hover:text-black transition-colors">${escapeHtml(meta.experiment_id || 'GENERAL')}</a>
                 </div>
                 <h1 class="text-5xl md:text-7xl font-black text-gray-900 tracking-tighter leading-none mb-8">${meta.title}</h1>
                 <div class="flex flex-wrap gap-2">
                    ${meta.tags.map(tag => `<span class="px-4 py-2 bg-gray-50 text-gray-400 rounded-full text-xs font-black uppercase tracking-widest border border-gray-100">#${tag}</span>`).join('')}
                 </div>
              </div>` : ''}
            <article class="prose-modern max-w-none">${renderedHtml}</article>
            ${relatedTasks.length > 0 ? `
              <div class="mt-16 pt-8 border-t border-gray-100">
                <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-6">${currentLang === 'zh' ? '相关任务' : 'Related Tasks'}</h3>
                <div class="space-y-4">
                  ${relatedTasks.map(task => `
                    <a href="/elog/#/tasks" class="block bold-card p-4 rounded-xl hover:border-accent transition-colors">
                      <div class="flex items-center gap-3">
                        <span class="text-sm ${task.isDone ? 'text-green-500' : 'text-gray-300'}">${task.isDone ? '✅' : '⬜'}</span>
                        <span class="font-bold text-gray-900">${escapeHtml(task.text)}</span>
                      </div>
                    </a>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>`;
      } catch (err) {
        console.error(err);
        content.innerHTML = `<div class="max-w-4xl mx-auto px-6 py-24 text-red-500 font-bold">Error loading log: ${err.message}</div>`;
      }
    }

    function escapeHtml(v) { return String(v).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;'); }
  </script>
</body>

</html>